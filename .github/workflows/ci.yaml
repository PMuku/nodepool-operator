# =============================================================================
# CI Pipeline - Continuous Integration
# =============================================================================
# Triggers: Pull requests to main branch
# Purpose: Validate code quality before merging
#
# Jobs:
#   1. lint    - Code quality (golangci-lint) + security (gosec)
#   2. test    - Unit tests + Integration tests (envtest)
#
# This pipeline does NOT build Docker images - that's for release.yaml
# We will use pre-built github actions for certain tasks. Refer to marketplace
# for details - https://github.com/marketplace
# =============================================================================

name: CI
on:
  workflow_dispatch:
  #pull_request:
  #  branches:
  #    - main
  #  paths-ignore:
  #    - '**.md'
  #    - '.github/ISSUE_TEMPLATE/**'

jobs:
  # ===========================================================================
  # Job: Lint & Security scan
  # ===========================================================================
  # Runs code quality and security checks
  # - golangci-lint: comprehensive Go linter
  # - gosec: Go security checker
  lint:
    name: Lint and Security scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
      - name: Clone the code
        uses: actions/checkout@v6
        #with:                    ##Needed only when cloning a different repo than the current one
        # repository: ''
        # refs: ''
        # token: ''

      - name: Setup Go env and add to path
        uses: actions/setup-go@v6
        with:
         go-version-file: 'go.mod'    ## Automatically detect go version from projects go.mod file

      - name:  Run lint / static analysis (golangci-lint)
        run: |
         make lint

      - name: Run gosec (Go security scanner)  ##Refer https://github.com/securego/gosec
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()                           ## Even if gosec fails (vul detected) we want reports to be uploaded. without this sarif upload will fail
        with:
          sarif_file: results.sarif

  # ===========================================================================
  # Job: Testing
  # ===========================================================================
  # Runs unit tests and integration tests
  # - Unit tests: Pure Go function tests (fast)
  # - Integration tests: Controller tests with envtest (fake K8s API)
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'

      - name: Run tests
        run: make test

      - name: Generate coverage HTML
        run: |
          go tool cover -html=cover.out -o coverage.html

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.html

  # ===========================================================================
  # Job: Build Check
  # ===========================================================================
  # Verifies that the Docker image can be built (without pushing)
  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: nodepool-operator:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max